#!/usr/bin/env node

var Glue = require('gluejs')
	, fs = require('fs')
	, jade = require('jade')
	, jadeRe = new RegExp('(.+)\\.jade$'); // re for jade template files

var js = new Glue()
	.basepath('../client') // perform all lookups from the dir
  .include('../client')  // includes all files in the dir
  .handler(jadeRe, function(opts, done) {
    var filename = opts.filename
      , tpl = jade.compile(fs.readFileSync(filename, 'utf8'), { client: true, filename: filename, compileDebug: false })
      , template = 'module.exports = ' + tpl + ';';
    
  	done(filename.replace(jadeRe, '$1.js'), template);
  }) // custome handler for (pre)compiling jade templates
  .replace({
		'socket.io': 'window.io',
    'jquery': 'window.$', // binds require('jquery') to window.$
		'underscore': 'window._',
		'Backbone': 'window.Backbone',
		'audiolib': 'window.audioLib'
  })
  .export('jasmed') // the package is output as window.jasmed
  .render(function (err, txt) {
    // or write the result to a file
    fs.writeFile('./public/javascripts/jasmed.js', txt);
  });
